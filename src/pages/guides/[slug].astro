---
// 指南详情页 - 长尾词文章
import BaseLayout from '../../layouts/BaseLayout.astro';
import { guidesDatabase, getGuideBySlug, getRelatedGuides } from '../../data/guidesDatabase';
import { getDllById } from '../../data/dllDatabase';
import { generateGuideSchema, BUILD_DATE } from '../../utils/seo';

// 静态路径生成
export function getStaticPaths() {
  return guidesDatabase.map((guide) => ({
    params: { slug: guide.slug },
    props: { guide }
  }));
}

const { guide } = Astro.props;
const schema = generateGuideSchema(guide);
const relatedGuides = getRelatedGuides(guide.slug, 3);
const relatedDlls = guide.relatedDlls.map(id => getDllById(id)).filter(Boolean);

// 处理 Markdown 内容 (简单转换)
function processContent(content: string): string {
  return content
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" class="text-blue-600 hover:underline" target="_blank" rel="noopener">$1</a>')
    .replace(/\n\n/g, '</p><p class="mb-4">')
    .replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre class="bg-gray-900 text-gray-100 p-4 rounded-lg overflow-x-auto my-4"><code>$2</code></pre>');
}
---

<BaseLayout 
  title={guide.metaTitle}
  description={guide.metaDescription}
  schema={schema}
>
  <!-- Breadcrumb -->
  <nav class="bg-gray-50 border-b border-gray-200 py-3">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <ol class="flex items-center gap-2 text-sm">
        <li><a href="/" class="text-gray-500 hover:text-blue-600">Home</a></li>
        <li class="text-gray-400">/</li>
        <li><a href="/guides" class="text-gray-500 hover:text-blue-600">Guides</a></li>
        <li class="text-gray-400">/</li>
        <li class="text-gray-900 font-medium truncate max-w-xs">{guide.title}</li>
      </ol>
    </div>
  </nav>

  <article class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="lg:grid lg:grid-cols-4 lg:gap-12">
      <!-- Table of Contents (Desktop) -->
      <aside class="hidden lg:block lg:col-span-1">
        <div class="sticky-toc bg-white border border-gray-200 rounded-xl p-5">
          <h2 class="font-semibold text-gray-900 mb-4">Table of Contents</h2>
          <nav class="space-y-2">
            {guide.sections.map((section, index) => (
              <a 
                href={`#section-${index}`}
                class="block text-sm text-gray-600 hover:text-blue-600 transition-colors"
              >
                {section.heading}
              </a>
            ))}
          </nav>
        </div>
      </aside>

      <!-- Main Content -->
      <div class="lg:col-span-3">
        <!-- Article Header -->
        <header class="mb-8">
          <div class="flex items-center gap-3 mb-4">
            <span class="text-xs font-medium text-blue-600 bg-blue-50 px-2.5 py-1 rounded-full">
              {guide.category}
            </span>
            <span class="text-sm text-gray-500">
              Updated: {guide.updateDate}
            </span>
          </div>
          
          <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
            {guide.title}
          </h1>
          
          <p class="text-xl text-gray-600 mb-6">
            {guide.excerpt}
          </p>
          
          <!-- Author & Trust -->
          <div class="flex items-center gap-4 text-sm text-gray-500">
            <div class="flex items-center gap-2">
              <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                </svg>
              </div>
              <span>By {guide.author}</span>
            </div>
            <div class="flex items-center gap-1.5 text-green-600">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
              </svg>
              <span>Verified {BUILD_DATE}</span>
            </div>
          </div>
        </header>

        <!-- TOC Mobile -->
        <div class="lg:hidden bg-gray-50 rounded-xl p-4 mb-8">
          <details>
            <summary class="font-semibold text-gray-900 cursor-pointer">Table of Contents</summary>
            <nav class="mt-3 space-y-2">
              {guide.sections.map((section, index) => (
                <a 
                  href={`#section-${index}`}
                  class="block text-sm text-gray-600 hover:text-blue-600"
                >
                  {section.heading}
                </a>
              ))}
            </nav>
          </details>
        </div>

        <!-- Article Content -->
        <div class="prose max-w-none">
          {guide.sections.map((section, index) => (
            <section id={`section-${index}`} class="mb-10">
              <h2 class="text-2xl font-bold text-gray-900 mb-4 scroll-mt-24">
                {section.heading}
              </h2>
              <div class="text-gray-700">
                <p class="mb-4" set:html={processContent(section.content)} />
              </div>
            </section>
          ))}
        </div>

        <!-- Related DLLs -->
        {relatedDlls.length > 0 && (
          <section class="mt-12 pt-8 border-t border-gray-200">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Related DLL Files</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
              {relatedDlls.map((dll) => dll && (
                <a 
                  href={`/dll/${dll.id}`}
                  class="bg-gray-50 hover:bg-blue-50 px-4 py-3 rounded-lg text-center transition-colors"
                >
                  <div class="font-medium text-gray-900">{dll.name}</div>
                  <div class="text-xs text-gray-500">{dll.size}</div>
                </a>
              ))}
            </div>
          </section>
        )}

        <!-- Related Guides -->
        {relatedGuides.length > 0 && (
          <section class="mt-12 pt-8 border-t border-gray-200">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Related Guides</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              {relatedGuides.map((related) => (
                <a 
                  href={`/guides/${related.slug}`}
                  class="bg-white border border-gray-200 rounded-xl p-4 hover:border-blue-300 transition-colors"
                >
                  <span class="text-xs text-blue-600 font-medium">{related.category}</span>
                  <h3 class="font-semibold text-gray-900 mt-1 line-clamp-2">{related.title}</h3>
                </a>
              ))}
            </div>
          </section>
        )}
      </div>
    </div>
  </article>
</BaseLayout>
