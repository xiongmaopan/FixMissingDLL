name: Monthly Content Expansion

on:
  schedule:
    # Run on the 1st of every month at 02:00 UTC
    - cron: '0 2 1 * *'
  workflow_dispatch:  # Allow manual trigger

jobs:
  expand-content:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: astro-site/package-lock.json
      
      - name: Install dependencies
        working-directory: ./astro-site
        run: npm ci
      
      - name: Generate new guides
        working-directory: ./astro-site
        run: |
          npx tsx scripts/auto-generate-guides.ts
          echo "New guides generated successfully"
      
      - name: Update build date
        working-directory: ./astro-site
        run: |
          BUILD_DATE=$(date -u +"%Y-%m-%d")
          sed -i "s/export const BUILD_DATE = .*/export const BUILD_DATE = '$BUILD_DATE';/" src/utils/seo.ts
      
      - name: Rebuild site
        working-directory: ./astro-site
        run: npm run build
      
      - name: Commit changes
        working-directory: ./astro-site
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "feat: monthly content expansion ($(date -u +%Y-%m))"
            git push
          fi
      
      - name: Deploy to Cloudflare Pages
        if: success()
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=fixmissingdll
          workingDirectory: astro-site

  # Notify search engines about new content
  ping-search-engines:
    needs: expand-content
    runs-on: ubuntu-latest
    
    steps:
      - name: Ping Google
        run: |
          curl -s "https://www.google.com/ping?sitemap=https://fixmissingdll.com/sitemap-index.xml"
          echo "Pinged Google"
      
      - name: Ping Bing
        run: |
          curl -s "https://www.bing.com/ping?sitemap=https://fixmissingdll.com/sitemap-index.xml"
          echo "Pinged Bing"
      
      - name: Ping IndexNow (Bing/Yandex)
        run: |
          # IndexNow for faster indexing
          curl -X POST "https://api.indexnow.org/indexnow" \
            -H "Content-Type: application/json" \
            -d '{
              "host": "fixmissingdll.com",
              "key": "your-indexnow-key",
              "urlList": [
                "https://fixmissingdll.com/",
                "https://fixmissingdll.com/guides/",
                "https://fixmissingdll.com/dll/"
              ]
            }' || true
          echo "Pinged IndexNow"
