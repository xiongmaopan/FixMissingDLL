/**
 * å‘å¸ƒä»Šå¤©çš„è®¡åˆ’å†…å®¹åˆ° auto-generated-guides.json
 * 
 * è¿è¡Œ: npx tsx scripts/publish-today.ts
 */

import * as fs from 'fs';
import * as path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

interface Guide {
  id: string;
  slug: string;
  title: string;
  metaTitle: string;
  metaDescription: string;
  excerpt: string;
  category: string;
  publishDate: string;
  updateDate: string;
  author: string;
  keywords: string[];
  searchVolume?: string;
  sections: { heading: string; content: string }[];
  relatedDlls: string[];
}

function main() {
  console.log('ðŸ“… Publishing today\'s scheduled content...\n');
  
  const today = new Date().toISOString().split('T')[0];
  console.log(`Today: ${today}\n`);
  
  // è¯»å–è®¡åˆ’å†…å®¹
  const scheduledPath = path.join(__dirname, '../src/data/scheduled-guides.json');
  const scheduledContent = JSON.parse(fs.readFileSync(scheduledPath, 'utf-8'));
  
  const guides: Guide[] = scheduledContent.guides || [];
  console.log(`ðŸ“Š Total scheduled guides: ${guides.length}`);
  
  // æ‰¾å‡ºä»Šå¤©è¦å‘å¸ƒçš„å†…å®¹
  const todaysGuides = guides.filter(g => g.publishDate === today);
  console.log(`ðŸ“ Guides to publish today: ${todaysGuides.length}`);
  
  if (todaysGuides.length === 0) {
    console.log('\nâŒ No guides scheduled for today.');
    console.log('Check scheduled-guides.json for available dates.');
    return;
  }
  
  // æ˜¾ç¤ºä»Šå¤©çš„å†…å®¹
  console.log('\nToday\'s content:');
  todaysGuides.forEach((g, i) => {
    console.log(`  ${i + 1}. ${g.slug}`);
    console.log(`     Title: ${g.title}`);
    console.log(`     Category: ${g.category}`);
  });
  
  // è¯»å–çŽ°æœ‰çš„å·²å‘å¸ƒå†…å®¹
  const autoGeneratedPath = path.join(__dirname, '../src/data/auto-generated-guides.json');
  let existingGuides: Guide[] = [];
  
  if (fs.existsSync(autoGeneratedPath)) {
    try {
      existingGuides = JSON.parse(fs.readFileSync(autoGeneratedPath, 'utf-8'));
      if (!Array.isArray(existingGuides)) {
        existingGuides = [];
      }
    } catch (e) {
      console.log('Creating new auto-generated-guides.json');
    }
  }
  
  console.log(`\nðŸ“š Existing published guides: ${existingGuides.length}`);
  
  // åˆå¹¶æ–°å†…å®¹ (é¿å…é‡å¤)
  const existingSlugs = new Set(existingGuides.map(g => g.slug));
  const newGuides = todaysGuides.filter(g => !existingSlugs.has(g.slug));
  
  if (newGuides.length === 0) {
    console.log('\nâš ï¸ All of today\'s guides are already published!');
    return;
  }
  
  const allGuides = [...existingGuides, ...newGuides];
  
  // ä¿å­˜
  fs.writeFileSync(autoGeneratedPath, JSON.stringify(allGuides, null, 2));
  
  console.log(`\nâœ… Published ${newGuides.length} new guides!`);
  console.log(`ðŸ“Š Total published guides: ${allGuides.length}`);
  
  // æ›´æ–° scheduled-guides.jsonï¼Œæ ‡è®°å·²å‘å¸ƒçš„å†…å®¹
  const remainingGuides = guides.filter(g => g.publishDate !== today || !newGuides.find(ng => ng.slug === g.slug));
  
  const updatedScheduled = {
    ...scheduledContent,
    lastPublishDate: today,
    publishedToday: newGuides.length,
    guides: remainingGuides
  };
  
  fs.writeFileSync(scheduledPath, JSON.stringify(updatedScheduled, null, 2));
  console.log(`ðŸ“… Remaining scheduled guides: ${remainingGuides.length}`);
  
  console.log('\nðŸŽ‰ Done! Next steps:');
  console.log('1. git add -A');
  console.log('2. git commit -m "Publish daily content"');
  console.log('3. git push');
}

main();
